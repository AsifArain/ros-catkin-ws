<title>gdm_tdlas: gdm_tdlas.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">gdm_tdlas.cpp</div>  </div>
</div>
<div class="contents">
<a href="gdm__tdlas_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">*</span>
<a name="l00003"></a>00003 <span class="comment">* Software License Agreement (BSD License)</span>
<a name="l00004"></a>00004 <span class="comment">*</span>
<a name="l00005"></a>00005 <span class="comment">*  Copyright (c)  2011, Ã–rebro University, Sweden</span>
<a name="l00006"></a>00006 <span class="comment">*  All rights reserved.</span>
<a name="l00007"></a>00007 <span class="comment">*</span>
<a name="l00008"></a>00008 <span class="comment">*  Redistribution and use in source and binary forms, with or without</span>
<a name="l00009"></a>00009 <span class="comment">*  modification, are permitted provided that the following conditions</span>
<a name="l00010"></a>00010 <span class="comment">*  are met:</span>
<a name="l00011"></a>00011 <span class="comment">*</span>
<a name="l00012"></a>00012 <span class="comment">*   * Redistributions of source code must retain the above copyright</span>
<a name="l00013"></a>00013 <span class="comment">*     notice, this list of conditions and the following disclaimer.</span>
<a name="l00014"></a>00014 <span class="comment">*   * Redistributions in binary form must reproduce the above</span>
<a name="l00015"></a>00015 <span class="comment">*     copyright notice, this list of conditions and the following</span>
<a name="l00016"></a>00016 <span class="comment">*     disclaimer in the documentation and/or other materials provided</span>
<a name="l00017"></a>00017 <span class="comment">*     with the distribution.</span>
<a name="l00018"></a>00018 <span class="comment">*</span>
<a name="l00019"></a>00019 <span class="comment">*  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00020"></a>00020 <span class="comment">*  &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00021"></a>00021 <span class="comment">*  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00022"></a>00022 <span class="comment">*  FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span>
<a name="l00023"></a>00023 <span class="comment">*  COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00024"></a>00024 <span class="comment">*  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00025"></a>00025 <span class="comment">*  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00026"></a>00026 <span class="comment">*  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<a name="l00027"></a>00027 <span class="comment">*  CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<a name="l00028"></a>00028 <span class="comment">*  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span>
<a name="l00029"></a>00029 <span class="comment">*  ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="l00030"></a>00030 <span class="comment">*  POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00031"></a>00031 <span class="comment"></span>
<a name="l00032"></a>00032 <span class="comment">*Authors:</span>
<a name="l00033"></a>00033 <span class="comment">*********************************************************************/</span> 
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="gdm__tdlas_8h.html">gdm_tdlas.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;std_msgs/Float32.h&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <a class="code" href="Types_8hpp.html#a51ef5fc7000fda5b09a4bc7f26c817d8">USING_NAMESPACE_QPOASES</a>
<a name="l00040"></a>00040 <span class="keyword">using namespace </span>std;
<a name="l00041"></a>00041 
<a name="l00042"></a><a class="code" href="gdm__tdlas_8cpp.html#a9292cdb1fe5d1204ecdbebe741c53c0a">00042</a> <span class="keywordtype">void</span> <a class="code" href="gdm__tdlas_8cpp.html#a9292cdb1fe5d1204ecdbebe741c53c0a">rmldInCallback</a>(<span class="keyword">const</span> <a class="code" href="structlocalized__RMLD_1_1rmld__msg__.html#ad6ae692d915a1d3a0cd0797b6ee528e4">localized_RMLD::rmld_msg::ConstPtr</a>&amp; msg_in){
<a name="l00043"></a>00043         <span class="keywordflow">if</span>(!<a class="code" href="gdm__tdlas_8h.html#aa2d37e3128a894269a8f288fe34f9002">new_data_arrived</a>){
<a name="l00044"></a>00044 
<a name="l00045"></a>00045                 <a class="code" href="gdm__tdlas_8h.html#a3e354c17f76d0f236627d5285272e653">measurementPPMM</a> = msg_in-&gt;concentration_ppmm;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047                 <a class="code" href="gdm__tdlas_8h.html#a8b43179bdb67e5ec9b19d23667f3ab38">lastPoint_Origin</a>.x = msg_in-&gt;origin_x;
<a name="l00048"></a>00048                 <a class="code" href="gdm__tdlas_8h.html#a8b43179bdb67e5ec9b19d23667f3ab38">lastPoint_Origin</a>.y = msg_in-&gt;origin_y;
<a name="l00049"></a>00049                 <a class="code" href="gdm__tdlas_8h.html#aa9e3139dbb4679af2b6dfab4559ac517">lastPoint_End</a>.x = msg_in-&gt;end_x;
<a name="l00050"></a>00050                 <a class="code" href="gdm__tdlas_8h.html#aa9e3139dbb4679af2b6dfab4559ac517">lastPoint_End</a>.y = msg_in-&gt;end_y;
<a name="l00051"></a>00051 
<a name="l00052"></a>00052                 <a class="code" href="gdm__tdlas_8h.html#aa2d37e3128a894269a8f288fe34f9002">new_data_arrived</a> = <span class="keyword">true</span>;
<a name="l00053"></a>00053         }
<a name="l00054"></a>00054 }
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="gdm__tdlas_8cpp.html#a2cce26a45fa8cc7c05809eda69e50caf">00056</a> <span class="keywordtype">void</span> <a class="code" href="gdm__tdlas_8cpp.html#a2cce26a45fa8cc7c05809eda69e50caf">updateGradient</a>(<a class="code" href="Types_8hpp.html#acfbb1546e581bff0de2fa030397dc14d">real_t</a> *<a class="code" href="qrecipe_8cpp.html#aaccc864902874c11795d0b5dcff64e15">g</a>, std::vector&lt;int&gt; *idx, std::vector&lt;float&gt; *val, <span class="keywordtype">float</span> ppmm){
<a name="l00057"></a>00057         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; idx-&gt;size(); i++){
<a name="l00058"></a>00058                 g[idx-&gt;at(i)] -= 2 * ppmm * val-&gt;at(i);
<a name="l00059"></a>00059         }
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="gdm__tdlas_8cpp.html#a770fbb72148815e193cb914c3b90672e">00062</a> <span class="keywordtype">void</span> <a class="code" href="gdm__tdlas_8cpp.html#a770fbb72148815e193cb914c3b90672e">printSparseMatrixInfo</a>(vector&lt;sparse_int_t&gt; *<a class="code" href="qrecipe_8cpp.html#a9008dd7c67da8c922a573332be31759a">H_jc</a>, vector&lt;sparse_int_t&gt; *<a class="code" href="qrecipe_8cpp.html#a0c4453307b17cb5b194ed25af899402d">H_ir</a>, vector&lt;real_t&gt; *<a class="code" href="qrecipe_8cpp.html#afb8cbf72d7053c0a2ef63e56218ea845">H_val</a>){
<a name="l00063"></a>00063         printf(<span class="stringliteral">&quot;\nColumns vector:\n&quot;</span>);
<a name="l00064"></a>00064         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; H_jc-&gt;size(); i++)
<a name="l00065"></a>00065                 printf(<span class="stringliteral">&quot;%d\t&quot;</span>,H_jc-&gt;at(i));
<a name="l00066"></a>00066         printf(<span class="stringliteral">&quot;\nRows vector:\n&quot;</span>);
<a name="l00067"></a>00067         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; H_ir-&gt;size(); i++)
<a name="l00068"></a>00068                 printf(<span class="stringliteral">&quot;%d\t&quot;</span>,H_ir-&gt;at(i));
<a name="l00069"></a>00069         printf(<span class="stringliteral">&quot;\nValues vector:\n&quot;</span>);
<a name="l00070"></a>00070         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; H_val-&gt;size(); i++)
<a name="l00071"></a>00071                 printf(<span class="stringliteral">&quot;%4.2f\t&quot;</span>,H_val-&gt;at(i));
<a name="l00072"></a>00072         printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="gdm__tdlas_8cpp.html#ab675358ab25a01aba70d16afe129fcfc">00075</a> <span class="keywordtype">void</span> <a class="code" href="gdm__tdlas_8cpp.html#ab675358ab25a01aba70d16afe129fcfc">updateHessian</a>(vector&lt;sparse_int_t&gt; *<a class="code" href="qrecipe_8cpp.html#a9008dd7c67da8c922a573332be31759a">H_jc</a>, vector&lt;sparse_int_t&gt; *<a class="code" href="qrecipe_8cpp.html#a0c4453307b17cb5b194ed25af899402d">H_ir</a>, vector&lt;real_t&gt; *<a class="code" href="qrecipe_8cpp.html#afb8cbf72d7053c0a2ef63e56218ea845">H_val</a>, std::vector&lt;int&gt; *idx, std::vector&lt;float&gt; *val){      
<a name="l00076"></a>00076         
<a name="l00077"></a>00077         <span class="comment">//index columns</span>
<a name="l00078"></a>00078         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; idx-&gt;size(); i++){
<a name="l00079"></a>00079                 <span class="comment">//index rows            </span>
<a name="l00080"></a>00080                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; idx-&gt;size(); j++){
<a name="l00081"></a>00081                         <span class="keywordtype">bool</span> already_present = <span class="keyword">false</span>;
<a name="l00082"></a>00082                         <a class="code" href="Types_8hpp.html#acfbb1546e581bff0de2fa030397dc14d">real_t</a> val_update = val-&gt;at(i)*val-&gt;at(j);      
<a name="l00083"></a>00083 
<a name="l00084"></a>00084                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> c = H_jc-&gt;at(idx-&gt;at(i)); c &lt; H_jc-&gt;at(idx-&gt;at(i)+1); c++){
<a name="l00085"></a>00085                                 <span class="keywordflow">if</span> (H_ir-&gt;at(c) == idx-&gt;at(j)){
<a name="l00086"></a>00086                                         already_present = <span class="keyword">true</span>;
<a name="l00087"></a>00087                                         H_val-&gt;at(c) += val_update;
<a name="l00088"></a>00088                                         <span class="keywordflow">break</span>;
<a name="l00089"></a>00089                                 }
<a name="l00090"></a>00090                         }
<a name="l00091"></a>00091                         
<a name="l00092"></a>00092                         <span class="comment">//add new element</span>
<a name="l00093"></a>00093                         <span class="keywordflow">if</span> (already_present == <span class="keyword">false</span>){
<a name="l00094"></a>00094                                 <span class="comment">//printf(&quot;\n\nInserting new element - row: %d, column: %d, value update: %4.2f\n&quot;,idx-&gt;at(j),idx-&gt;at(i),val_update);</span>
<a name="l00095"></a>00095                                 vector &lt;sparse_int_t&gt;::iterator i_int = H_ir-&gt;begin();
<a name="l00096"></a>00096                                 vector &lt;real_t&gt;::iterator i_real = H_val-&gt;begin();
<a name="l00097"></a>00097                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset = 0;
<a name="l00098"></a>00098                                 <span class="keywordtype">bool</span> offsetOK = <span class="keyword">false</span>;                          
<a name="l00099"></a>00099                                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = H_jc-&gt;at(idx-&gt;at(i)); k &lt; H_jc-&gt;at(idx-&gt;at(i)+1) ; k++){
<a name="l00100"></a>00100                                         <span class="keywordflow">if</span> (idx-&gt;at(j) &lt; H_ir-&gt;at(k)){
<a name="l00101"></a>00101                                                 offset = k;
<a name="l00102"></a>00102                                                 offsetOK = <span class="keyword">true</span>;
<a name="l00103"></a>00103                                                 <span class="keywordflow">break</span>;
<a name="l00104"></a>00104                                         }                               
<a name="l00105"></a>00105                                 }
<a name="l00106"></a>00106                                 
<a name="l00107"></a>00107                                 <span class="keywordflow">if</span> (offsetOK == <span class="keyword">false</span>){
<a name="l00108"></a>00108                                         offset = H_jc-&gt;at(idx-&gt;at(i)+1);        
<a name="l00109"></a>00109                                 }
<a name="l00110"></a>00110                                 
<a name="l00111"></a>00111                                 H_ir-&gt;insert(i_int + offset,idx-&gt;at(j));
<a name="l00112"></a>00112                                 H_val-&gt;insert(i_real + offset,val_update);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114                                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = idx-&gt;at(i)+1; c &lt; H_jc-&gt;size(); c++){
<a name="l00115"></a>00115                                         H_jc-&gt;at(c)++;
<a name="l00116"></a>00116                                 }
<a name="l00117"></a>00117                         }                               
<a name="l00118"></a>00118                 }
<a name="l00119"></a>00119         }
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a><a class="code" href="gdm__tdlas_8cpp.html#a3c04138a5bfe5d72780bb7e82a18e627">00122</a> <span class="keywordtype">int</span> <a class="code" href="example1_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124         <span class="comment">//Ros initialization</span>
<a name="l00125"></a>00125         <a class="code" href="matlab_2qpOASES__sequence_8cpp.html#af53e3224ebf0c32edaa86766930a6fd1">ros::init</a>(argc, argv, <a class="code" href="gdm__tdlas_8h.html#a8cc8d559acdd2f74085b20977182d5b7">NODE_NAME</a>);
<a name="l00126"></a>00126         ros::NodeHandle n;
<a name="l00127"></a>00127 
<a name="l00128"></a>00128         <span class="comment">//Parameters</span>
<a name="l00129"></a>00129         ros::NodeHandle param_n(<span class="stringliteral">&quot;~&quot;</span>);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131         param_n.getParam(<span class="stringliteral">&quot;MIN_X&quot;</span>, <a class="code" href="gdm__tdlas_8h.html#a3e390754b32f87824ad96ec0888958d3">MIN_X</a>);
<a name="l00132"></a>00132         param_n.getParam(<span class="stringliteral">&quot;MAX_X&quot;</span>, <a class="code" href="gdm__tdlas_8h.html#a902cb51b772cd4387192501e97bd7198">MAX_X</a>);
<a name="l00133"></a>00133         param_n.getParam(<span class="stringliteral">&quot;MIN_Y&quot;</span>, <a class="code" href="gdm__tdlas_8h.html#a188814c015e92c2bd4daa2f823f07b75">MIN_Y</a>);
<a name="l00134"></a>00134         param_n.getParam(<span class="stringliteral">&quot;MAX_Y&quot;</span>, <a class="code" href="gdm__tdlas_8h.html#a143bc3c46d0e3fb1e70a2e7da2186b92">MAX_Y</a>);
<a name="l00135"></a>00135         param_n.getParam(<span class="stringliteral">&quot;CELL_SIZE&quot;</span>, <a class="code" href="gdm__tdlas_8h.html#a4cf9ff51a66312cba25005de9de38c30">CELL_SIZE</a>);
<a name="l00136"></a>00136         param_n.getParam(<span class="stringliteral">&quot;MAX_CONC&quot;</span>, <a class="code" href="gdm__tdlas_8h.html#aeef37ba19f1932a31b8448cc54397c54">MAX_CONC</a>);
<a name="l00137"></a>00137         param_n.getParam(<span class="stringliteral">&quot;FIXED_FRAME&quot;</span>, <a class="code" href="gdm__tdlas_8h.html#ae723813911dffa4fe96261e3bc59c131">FIXED_FRAME</a>);
<a name="l00138"></a>00138         param_n.getParam(<span class="stringliteral">&quot;RMLD_TOPIC&quot;</span>, <a class="code" href="gdm__tdlas_8h.html#af39580a9f105347cdb67f69321780bb8">RMLD_TOPIC</a>);
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         <span class="comment">//Subscriptions</span>
<a name="l00142"></a>00142         ros::Subscriber sub = n.subscribe(<a class="code" href="gdm__tdlas_8h.html#af39580a9f105347cdb67f69321780bb8">RMLD_TOPIC</a>, 1000, <a class="code" href="gdm__tdlas_8cpp.html#a9292cdb1fe5d1204ecdbebe741c53c0a">rmldInCallback</a>);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144         ros::Publisher  tdlas_advertise=n.advertise&lt;visualization_msgs::MarkerArray&gt;(<span class="stringliteral">&quot;gdm_tdlas&quot;</span>, 20);
<a name="l00145"></a>00145         
<a name="l00146"></a>00146         <span class="comment">//Global initializations</span>
<a name="l00147"></a>00147         ros::Rate loop_rate(<a class="code" href="gdm__tdlas_8h.html#acd97b33c4ed6a53a3c744ea2f76bd378">LOOP_RATE_HZ</a>);
<a name="l00148"></a>00148         <a class="code" href="gdm__tdlas_8h.html#aa2d37e3128a894269a8f288fe34f9002">new_data_arrived</a> = <span class="keyword">false</span>;
<a name="l00149"></a>00149         <a class="code" href="gdm__tdlas_8h.html#ade0f976bd45ebb046e717c19f8361b8a">gas_map</a> = <span class="keyword">new</span> <a class="code" href="classGdmTDLAS_1_1GasMap.html">GdmTDLAS::GasMap</a>(<a class="code" href="gdm__tdlas_8h.html#a3e390754b32f87824ad96ec0888958d3">MIN_X</a>,<a class="code" href="gdm__tdlas_8h.html#a902cb51b772cd4387192501e97bd7198">MAX_X</a>,<a class="code" href="gdm__tdlas_8h.html#a188814c015e92c2bd4daa2f823f07b75">MIN_Y</a>,<a class="code" href="gdm__tdlas_8h.html#a143bc3c46d0e3fb1e70a2e7da2186b92">MAX_Y</a>,<a class="code" href="gdm__tdlas_8h.html#a4cf9ff51a66312cba25005de9de38c30">CELL_SIZE</a>,<a class="code" href="gdm__tdlas_8h.html#aeef37ba19f1932a31b8448cc54397c54">MAX_CONC</a>,<a class="code" href="gdm__tdlas_8h.html#ae723813911dffa4fe96261e3bc59c131">FIXED_FRAME</a>); 
<a name="l00150"></a>00150         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot_num_cells = <a class="code" href="gdm__tdlas_8h.html#ade0f976bd45ebb046e717c19f8361b8a">gas_map</a>-&gt;<a class="code" href="classGdmTDLAS_1_1GasMap.html#a4cca67f1052210b0fc3a51fb89281368">getRows</a>() * <a class="code" href="gdm__tdlas_8h.html#ade0f976bd45ebb046e717c19f8361b8a">gas_map</a>-&gt;<a class="code" href="classGdmTDLAS_1_1GasMap.html#af82b54856faf2eea9d553fd89c1cc71d">getCols</a>();
<a name="l00151"></a>00151         <span class="keywordtype">double</span> cputime = 0.1;
<a name="l00152"></a>00152         <span class="keywordtype">int</span> nWSR = 100000;
<a name="l00153"></a>00153         <span class="keywordtype">float</span> objValOffset = 0.0;
<a name="l00154"></a>00154         
<a name="l00155"></a>00155         <a class="code" href="classSQProblem.html" title="Implements the online active set strategy for QPs with varying matrices.">SQProblem</a> <a class="code" href="qpOASESroutines_8cpp.html#aceda8d7523613f0f0913e593aeade348">qp</a>(tot_num_cells,0);
<a name="l00156"></a>00156         <a class="code" href="MessageHandling_8hpp.html#a81d556f613bfbabd0b1f9488c0fa865e" title="Defines all symbols for global return values.">returnValue</a> rv;
<a name="l00157"></a>00157         
<a name="l00158"></a>00158         vector&lt;sparse_int_t&gt; <a class="code" href="qrecipe_8cpp.html#a9008dd7c67da8c922a573332be31759a">H_jc</a>(tot_num_cells+1);
<a name="l00159"></a>00159         vector&lt;sparse_int_t&gt; <a class="code" href="qrecipe_8cpp.html#a0c4453307b17cb5b194ed25af899402d">H_ir</a>(tot_num_cells);
<a name="l00160"></a>00160         vector&lt;real_t&gt; <a class="code" href="qrecipe_8cpp.html#afb8cbf72d7053c0a2ef63e56218ea845">H_val</a>(tot_num_cells);
<a name="l00161"></a>00161         <a class="code" href="Types_8hpp.html#acfbb1546e581bff0de2fa030397dc14d">real_t</a> <a class="code" href="qrecipe_8cpp.html#aaccc864902874c11795d0b5dcff64e15">g</a>[tot_num_cells];
<a name="l00162"></a>00162         <a class="code" href="Types_8hpp.html#acfbb1546e581bff0de2fa030397dc14d">real_t</a> <a class="code" href="qrecipe_8cpp.html#a3d4162b20ecb6df369f34d3c822acc71">lb</a>[tot_num_cells];
<a name="l00163"></a>00163         vector&lt;real_t&gt; xOpt(tot_num_cells);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 
<a name="l00166"></a>00166         <span class="comment">//initialize gradient and lower bounds</span>
<a name="l00167"></a>00167         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; tot_num_cells; i++){
<a name="l00168"></a>00168                 g[i] = 0;
<a name="l00169"></a>00169                 lb[i] = 0;
<a name="l00170"></a>00170                 H_jc[i] = i;
<a name="l00171"></a>00171                 H_ir[i] = i;
<a name="l00172"></a>00172                 H_val[i] = 0.0001;
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175         H_jc[tot_num_cells] = tot_num_cells;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177         <a class="code" href="classSymSparseMat.html" title="Interfaces matrix-vector operations tailored to symmetric sparse matrices.">SymSparseMat</a> *<a class="code" href="classQProblemB.html#a10b5660ca133fee1cedbb9636cea8431">H</a> = <span class="keyword">new</span> <a class="code" href="classSymSparseMat.html" title="Interfaces matrix-vector operations tailored to symmetric sparse matrices.">SymSparseMat</a>(tot_num_cells, tot_num_cells, &amp;H_ir[0], &amp;H_jc[0], &amp;H_val[0]);
<a name="l00178"></a>00178         H-&gt;<a class="code" href="classSparseMatrix.html#ac81c1ddda42b186de118b6eab49a1852">createDiagInfo</a>();
<a name="l00179"></a>00179 
<a name="l00180"></a>00180         <span class="comment">//solve first QP</span>
<a name="l00181"></a>00181         qp.<a class="code" href="classQProblemB.html#a2be2208a1befa1f7fa03f3c11d91ae7b">setPrintLevel</a>(<a class="code" href="Types_8hpp.html#a83ff212f474e3669d8fac2d727f65de5a8f8368df28c91ba1e51b3977a7ea8ac8">PL_NONE</a>);
<a name="l00182"></a>00182         rv = qp.<a class="code" href="classQProblem.html#aa286539b43de9a08bc18a9d70c799008">init</a>( H,g,NULL,lb,NULL,NULL,NULL,nWSR,&amp;cputime);                
<a name="l00183"></a>00183 
<a name="l00184"></a>00184         <span class="keywordflow">switch</span>(rv){
<a name="l00185"></a>00185                 <span class="keywordflow">case</span> <a class="code" href="MessageHandling_8hpp.html#a81d556f613bfbabd0b1f9488c0fa865eaec77507a25a637aa3a6650ba26875984">SUCCESSFUL_RETURN</a>:
<a name="l00186"></a>00186                         <span class="keywordflow">if</span> (qp.<a class="code" href="classQProblemB.html#a607c62c249e783aaafe62035dfa694f7">getPrimalSolution</a>(&amp;xOpt[0]) == <a class="code" href="MessageHandling_8hpp.html#a81d556f613bfbabd0b1f9488c0fa865ea287dca546b474635c6d5622e921569c4">RET_QP_NOT_SOLVED</a>){
<a name="l00187"></a>00187                                 ROS_INFO(<span class="stringliteral">&quot;Map initialization failed!&quot;</span>);
<a name="l00188"></a>00188                                 <span class="keywordflow">return</span> 1;
<a name="l00189"></a>00189                         }
<a name="l00190"></a>00190                         <span class="keywordflow">else</span>{
<a name="l00191"></a>00191                                 <a class="code" href="gdm__tdlas_8h.html#ade0f976bd45ebb046e717c19f8361b8a">gas_map</a>-&gt;<a class="code" href="classGdmTDLAS_1_1GasMap.html#a685787c256f39512c7546845435a3f10">updateMap</a>(&amp;xOpt);
<a name="l00192"></a>00192                                 <a class="code" href="gdm__tdlas_8h.html#ade0f976bd45ebb046e717c19f8361b8a">gas_map</a>-&gt;<a class="code" href="classGdmTDLAS_1_1GasMap.html#ae1284c715e3e1861a5d564e97c2daf24">publish</a>(tdlas_advertise);
<a name="l00193"></a>00193                                 ROS_INFO(<span class="stringliteral">&quot;Map initialized!&quot;</span>);
<a name="l00194"></a>00194                         }
<a name="l00195"></a>00195                         <span class="keywordflow">break</span>;
<a name="l00196"></a>00196                 <span class="keywordflow">case</span> <a class="code" href="MessageHandling_8hpp.html#a81d556f613bfbabd0b1f9488c0fa865eaae4f4541f015531f0d19acc9810665ba">RET_MAX_NWSR_REACHED</a>:
<a name="l00197"></a>00197                         ROS_INFO(<span class="stringliteral">&quot;Map initialization: max working set recalculation reached!&quot;</span>); 
<a name="l00198"></a>00198                         qp.<a class="code" href="classQProblem.html#a2f752d39b6935d929b963363a314b6bd">reset</a>();
<a name="l00199"></a>00199                         <span class="keywordflow">break</span>;
<a name="l00200"></a>00200                 <span class="keywordflow">case</span> <a class="code" href="MessageHandling_8hpp.html#a81d556f613bfbabd0b1f9488c0fa865eadb8ab9888977627abbebc017e9dcd083">RET_INIT_FAILED</a>:
<a name="l00201"></a>00201                         ROS_INFO(<span class="stringliteral">&quot;Map initialization failed!&quot;</span>);
<a name="l00202"></a>00202                         <span class="keywordflow">return</span> 1;
<a name="l00203"></a>00203                 <span class="keywordflow">default</span>:
<a name="l00204"></a>00204                         ROS_INFO(<span class="stringliteral">&quot;Map initialization: Unhandled return value!&quot;</span>);
<a name="l00205"></a>00205                         <span class="keywordflow">break</span>;
<a name="l00206"></a>00206         }
<a name="l00207"></a>00207         cputime = 1.0;
<a name="l00208"></a>00208         nWSR = 100000;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="comment">//find map limits</span>
<a name="l00211"></a>00211         <span class="comment">/*float max_x = -1000;</span>
<a name="l00212"></a>00212 <span class="comment">        float max_y = -1000;</span>
<a name="l00213"></a>00213 <span class="comment">        float min_x = 1000;</span>
<a name="l00214"></a>00214 <span class="comment">        float min_y = 1000;*/</span>
<a name="l00215"></a>00215 
<a name="l00216"></a>00216         <a class="code" href="gdm__tdlas_8h.html#ade0f976bd45ebb046e717c19f8361b8a">gas_map</a>-&gt;<a class="code" href="classGdmTDLAS_1_1GasMap.html#a68f6dddfbd7096d57417649a790f7873">printInfo</a>();
<a name="l00217"></a>00217 
<a name="l00218"></a>00218         <span class="comment">//Main loop</span>
<a name="l00219"></a>00219         <span class="keywordflow">while</span> (ros::ok()){
<a name="l00220"></a>00220                 <span class="comment">//ROS_INFO(&quot;Spinning&quot;);</span>
<a name="l00221"></a>00221         
<a name="l00222"></a>00222                 <span class="keywordflow">if</span>(<a class="code" href="gdm__tdlas_8h.html#aa2d37e3128a894269a8f288fe34f9002">new_data_arrived</a>){
<a name="l00223"></a>00223                         
<a name="l00224"></a>00224                         <a class="code" href="gdm__tdlas_8h.html#ae711d53dd6a1e1c200e3b57589cbad0a">mutex_rmld</a>.lock();
<a name="l00225"></a>00225 
<a name="l00226"></a>00226                         <span class="comment">//when octomap is unable to project a ray in the 3d model or</span>
<a name="l00227"></a>00227                         <span class="comment">//when there is tf missing, the rmld driver returns -1 as an</span>
<a name="l00228"></a>00228                         <span class="comment">//integral concentration measurement</span>
<a name="l00229"></a>00229                         ROS_INFO(<span class="stringliteral">&quot;From [%f,%f] to [%f,%f] = %fPPMM&quot;</span>, \
<a name="l00230"></a>00230                                 <a class="code" href="gdm__tdlas_8h.html#a8b43179bdb67e5ec9b19d23667f3ab38">lastPoint_Origin</a>.x,<a class="code" href="gdm__tdlas_8h.html#a8b43179bdb67e5ec9b19d23667f3ab38">lastPoint_Origin</a>.y, \
<a name="l00231"></a>00231                                 <a class="code" href="gdm__tdlas_8h.html#aa9e3139dbb4679af2b6dfab4559ac517">lastPoint_End</a>.x,<a class="code" href="gdm__tdlas_8h.html#aa9e3139dbb4679af2b6dfab4559ac517">lastPoint_End</a>.y, \
<a name="l00232"></a>00232                                 <a class="code" href="gdm__tdlas_8h.html#a3e354c17f76d0f236627d5285272e653">measurementPPMM</a>);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234                         <span class="comment">/*if (measurementPPMM != -1){</span>
<a name="l00235"></a>00235 <span class="comment">                                if (max_x &lt; lastPoint_Origin.x)</span>
<a name="l00236"></a>00236 <span class="comment">                                        max_x = lastPoint_Origin.x;</span>
<a name="l00237"></a>00237 <span class="comment">                                if (max_x &lt; lastPoint_End.x)</span>
<a name="l00238"></a>00238 <span class="comment">                                        max_x = lastPoint_End.x;</span>
<a name="l00239"></a>00239 <span class="comment">                                if (min_x &gt; lastPoint_Origin.x)</span>
<a name="l00240"></a>00240 <span class="comment">                                        min_x = lastPoint_Origin.x;</span>
<a name="l00241"></a>00241 <span class="comment">                                if (min_x &gt; lastPoint_End.x)</span>
<a name="l00242"></a>00242 <span class="comment">                                        min_x = lastPoint_End.x;</span>
<a name="l00243"></a>00243 <span class="comment"></span>
<a name="l00244"></a>00244 <span class="comment">                                if (max_y &lt; lastPoint_Origin.y)</span>
<a name="l00245"></a>00245 <span class="comment">                                        max_y = lastPoint_Origin.y;</span>
<a name="l00246"></a>00246 <span class="comment">                                if (max_y &lt; lastPoint_End.y)</span>
<a name="l00247"></a>00247 <span class="comment">                                        max_y = lastPoint_End.y;</span>
<a name="l00248"></a>00248 <span class="comment">                                if (min_y &gt; lastPoint_Origin.y)</span>
<a name="l00249"></a>00249 <span class="comment">                                        min_y = lastPoint_Origin.y;</span>
<a name="l00250"></a>00250 <span class="comment">                                if (min_y &gt; lastPoint_End.y)</span>
<a name="l00251"></a>00251 <span class="comment">                                        min_y = lastPoint_End.y;</span>
<a name="l00252"></a>00252 <span class="comment"></span>
<a name="l00253"></a>00253 <span class="comment">                                printf(&quot;\nLimits x: %4.2f - %4.2f\nLimits y: %4.2f - %4.2f\n&quot;,min_x,max_x,min_y,max_y);</span>
<a name="l00254"></a>00254 <span class="comment">                        }*/</span>
<a name="l00255"></a>00255 
<a name="l00256"></a>00256                         vector&lt;int&gt; idx;
<a name="l00257"></a>00257                         vector&lt;float&gt; val;              
<a name="l00258"></a>00258                         <span class="keywordflow">if</span>(<a class="code" href="gdm__tdlas_8h.html#ade0f976bd45ebb046e717c19f8361b8a">gas_map</a>-&gt;<a class="code" href="classGdmTDLAS_1_1GasMap.html#a3fdac43a976274f4b2b44dde9f8d1dba">CalculateNewMeasurementRow</a>(<a class="code" href="gdm__tdlas_8h.html#a8b43179bdb67e5ec9b19d23667f3ab38">lastPoint_Origin</a>, <a class="code" href="gdm__tdlas_8h.html#aa9e3139dbb4679af2b6dfab4559ac517">lastPoint_End</a>, <a class="code" href="gdm__tdlas_8h.html#a3e354c17f76d0f236627d5285272e653">measurementPPMM</a>, &amp;idx, &amp;val)){
<a name="l00259"></a>00259                                 <span class="comment">//update matrices</span>
<a name="l00260"></a>00260                                 <a class="code" href="gdm__tdlas_8cpp.html#a2cce26a45fa8cc7c05809eda69e50caf">updateGradient</a>(g,&amp;idx,&amp;val,<a class="code" href="gdm__tdlas_8h.html#a3e354c17f76d0f236627d5285272e653">measurementPPMM</a>);    
<a name="l00261"></a>00261                                 <a class="code" href="gdm__tdlas_8cpp.html#ab675358ab25a01aba70d16afe129fcfc">updateHessian</a>(&amp;H_jc,&amp;H_ir,&amp;H_val,&amp;idx,&amp;val);
<a name="l00262"></a>00262                                 objValOffset += <a class="code" href="gdm__tdlas_8h.html#a3e354c17f76d0f236627d5285272e653">measurementPPMM</a>*<a class="code" href="gdm__tdlas_8h.html#a3e354c17f76d0f236627d5285272e653">measurementPPMM</a>;
<a name="l00263"></a>00263                 
<a name="l00264"></a>00264                                 <span class="keyword">delete</span> <a class="code" href="classQProblemB.html#a10b5660ca133fee1cedbb9636cea8431">H</a>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266                                 H = <span class="keyword">new</span> <a class="code" href="classSymSparseMat.html" title="Interfaces matrix-vector operations tailored to symmetric sparse matrices.">SymSparseMat</a>(tot_num_cells, tot_num_cells, &amp;H_ir[0], &amp;H_jc[0], &amp;H_val[0]);
<a name="l00267"></a>00267                                 H-&gt;<a class="code" href="classSparseMatrix.html#ac81c1ddda42b186de118b6eab49a1852">createDiagInfo</a>();
<a name="l00268"></a>00268 
<a name="l00269"></a>00269                                 rv = qp.<a class="code" href="classSQProblem.html#ae857262f55e360c3e1e4295c8d713270">hotstart</a>( H,g,NULL,&amp;lb[0],NULL,NULL,NULL,nWSR,&amp;cputime);                
<a name="l00270"></a>00270 
<a name="l00271"></a>00271                                 <span class="keywordflow">switch</span>(rv){
<a name="l00272"></a>00272                                         <span class="keywordflow">case</span> <a class="code" href="MessageHandling_8hpp.html#a81d556f613bfbabd0b1f9488c0fa865eaec77507a25a637aa3a6650ba26875984">SUCCESSFUL_RETURN</a>:
<a name="l00273"></a>00273                                                 <span class="keywordflow">if</span> (qp.<a class="code" href="classQProblemB.html#a607c62c249e783aaafe62035dfa694f7">getPrimalSolution</a>(&amp;xOpt[0]) == <a class="code" href="MessageHandling_8hpp.html#a81d556f613bfbabd0b1f9488c0fa865ea287dca546b474635c6d5622e921569c4">RET_QP_NOT_SOLVED</a>)
<a name="l00274"></a>00274                                                         ROS_INFO(<span class="stringliteral">&quot;Map update failed!&quot;</span>);
<a name="l00275"></a>00275                                                 <span class="keywordflow">else</span>{
<a name="l00276"></a>00276                                                         <a class="code" href="gdm__tdlas_8h.html#ade0f976bd45ebb046e717c19f8361b8a">gas_map</a>-&gt;<a class="code" href="classGdmTDLAS_1_1GasMap.html#a685787c256f39512c7546845435a3f10">updateMap</a>(&amp;xOpt);
<a name="l00277"></a>00277                                                         <a class="code" href="gdm__tdlas_8h.html#ade0f976bd45ebb046e717c19f8361b8a">gas_map</a>-&gt;<a class="code" href="classGdmTDLAS_1_1GasMap.html#ae1284c715e3e1861a5d564e97c2daf24">publish</a>(tdlas_advertise);
<a name="l00278"></a>00278                                                         ROS_INFO(<span class="stringliteral">&quot;Map updated successfully in %4.4f seconds!&quot;</span>,cputime);
<a name="l00279"></a>00279                                                 }
<a name="l00280"></a>00280                                                 <span class="keywordflow">break</span>;
<a name="l00281"></a>00281                                         <span class="keywordflow">case</span> <a class="code" href="MessageHandling_8hpp.html#a81d556f613bfbabd0b1f9488c0fa865eaae4f4541f015531f0d19acc9810665ba">RET_MAX_NWSR_REACHED</a>:
<a name="l00282"></a>00282                                                 ROS_INFO(<span class="stringliteral">&quot;Map update: max working set recalculation reached!&quot;</span>); 
<a name="l00283"></a>00283                                                 qp.<a class="code" href="classQProblem.html#a2f752d39b6935d929b963363a314b6bd">reset</a>();
<a name="l00284"></a>00284                                                 <span class="keywordflow">break</span>;
<a name="l00285"></a>00285                                         <span class="keywordflow">case</span> <a class="code" href="MessageHandling_8hpp.html#a81d556f613bfbabd0b1f9488c0fa865ea1c9fe897988e88507265cac330960522">RET_HOTSTART_FAILED</a>:
<a name="l00286"></a>00286                                                 ROS_INFO(<span class="stringliteral">&quot;Map update failed!&quot;</span>);
<a name="l00287"></a>00287                                         <span class="keywordflow">default</span>:
<a name="l00288"></a>00288                                                 ROS_INFO(<span class="stringliteral">&quot;Map update: unhandled return value!&quot;</span>);
<a name="l00289"></a>00289                                                 <span class="keywordflow">break</span>;
<a name="l00290"></a>00290                                 }
<a name="l00291"></a>00291                                 cputime = 0.1;
<a name="l00292"></a>00292                                 nWSR = 10000;
<a name="l00293"></a>00293                                 
<a name="l00294"></a>00294                         }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296                         <a class="code" href="gdm__tdlas_8h.html#aa2d37e3128a894269a8f288fe34f9002">new_data_arrived</a>=<span class="keyword">false</span>;
<a name="l00297"></a>00297                         <a class="code" href="gdm__tdlas_8h.html#ae711d53dd6a1e1c200e3b57589cbad0a">mutex_rmld</a>.unlock();
<a name="l00298"></a>00298                 <span class="comment">//--------------------------------------------------------------//</span>
<a name="l00299"></a>00299                 <span class="comment">//--------------------------------------------------------------//</span>
<a name="l00300"></a>00300 
<a name="l00301"></a>00301                 }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303                 ros::spinOnce();
<a name="l00304"></a>00304                 loop_rate.sleep();
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307         <span class="keyword">delete</span> <a class="code" href="gdm__tdlas_8h.html#ade0f976bd45ebb046e717c19f8361b8a">gas_map</a>;
<a name="l00308"></a>00308         <span class="keyword">delete</span> <a class="code" href="classQProblemB.html#a10b5660ca133fee1cedbb9636cea8431">H</a>;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310         <span class="keywordflow">return</span> 0;       
<a name="l00311"></a>00311 }
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


<br clear="all" />
<hr size="1"><div style="align: right;">
<a href="http://ros.org/wiki/gdm_tdlas">gdm_tdlas</a><br />
Author(s): Victor Hernandez</br />
<small>autogenerated on Fri Jul 27 2012 16:09:56</small>
</div>
</body>
</html>
